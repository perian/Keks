(()=>{"use strict";window.utils={getRandomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e),getRandomArrayElement:e=>e[window.utils.getRandomInt(0,e.length)],getRandomArrayLength:e=>{const t=window.utils.getRandomInt(0,e.length);return e.slice(0,t)},transformToInteger:e=>parseInt(e.replace("px",""),10),toggleFormElementsState:(e,t)=>{for(let n of e)n.disabled=t}},window.load=(e,t,n,o,a)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{let e;switch(i.status){case 200:n(i.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;case 408:e="Вышло время ожидания запроса";break;default:e="Cтатус ответа: : "+i.status+" "+i.statusText}e&&o(e)})),i.timeout="10000",i.addEventListener("timeout",(()=>{o("Запрос не выполнился за "+i.timeout+"мс")})),i.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),i.open(e,t),"GET"===e?i.send():"POST"===e&&i.send(a)},window.data={createFeatures:e=>{const t=[];for(let n=0;n<e.length;n++){let o={author:{avatar:e[n].author.avatar},offer:{title:e[n].offer.title,address:e[n].offer.address,price:e[n].offer.price,type:e[n].offer.type,rooms:e[n].offer.rooms,guests:e[n].offer.guests,checkin:e[n].offer.checkin,checkout:e[n].offer.checkout,features:e[n].offer.features,description:e[n].offer.description,photos:e[n].offer.photos},location:{x:e[n].location.x,y:e[n].location.y},id:n};t.push(o)}return t},houseTypes:{bungalow:{name:"Бунгало",minPrice:0},flat:{name:"Квартира",minPrice:1e3},house:{name:"Дом",minPrice:5e3},palace:{name:"Дворец",minPrice:1e4}}},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.createPin=t=>{const n=e.cloneNode(!0),o=n.querySelector("img");return n.style.left=t.location.x+25+"px",n.style.top=t.location.y+70+"px",o.src=t.author.avatar,o.alt=t.offer.description,o.dataset.id=t.id,n.dataset.id=t.id,n}})(),(()=>{const e="570px",t="375px",n=document.querySelector(".ad-form"),o=document.querySelector("#address"),a=n.querySelectorAll("fieldset");window.utils.toggleFormElementsState(a,!0);const i=n.querySelector("#room_number"),r=n.querySelector("#capacity"),s=()=>{const e=parseInt(i.value,10),t=parseInt(r.value,10);e<t?(r.invalid=!0,r.setCustomValidity(`Максимум гостей ${e}`)):100===e&&0!==t?(r.setCustomValidity("Не для гостей"),r.invalid=!0):e<100&&0===t?(r.invalid=!0,r.setCustomValidity("Поселите хоть кого-нибудь!")):(r.valid=!0,r.setCustomValidity("")),r.reportValidity()};i.addEventListener("change",s),r.addEventListener("change",s),s();const d=n.querySelector("#type"),c=n.querySelector("#price"),l=()=>{const e=window.data.houseTypes[d.value].minPrice;c.setAttribute("min",e),c.setAttribute("placeholder",e)};l();const m=()=>{l();const e=parseInt(c.value,10),t=window.data.houseTypes[d.value].minPrice;e<t?(c.invalid=!0,c.setCustomValidity(`Значение должно быть больше или ровно ${t}`)):e>1e6?(c.invalid=!0,c.setCustomValidity("Значение должно быть меньше или ровно 1000000")):(c.valid=!0,c.setCustomValidity("")),c.reportValidity()};d.addEventListener("change",m),c.addEventListener("change",m);const p=n.querySelector("#timein"),u=n.querySelector("#timeout");p.addEventListener("change",(()=>{u.value=p.value})),u.addEventListener("change",(()=>{p.value=u.value}));const w=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),f=document.querySelector("main"),y=()=>{w.removeEventListener("click",v),document.removeEventListener("keydown",_),document.querySelector(".success").remove()},v=()=>{y()},_=e=>{"Escape"===e.key&&y()},E=()=>{w.addEventListener("click",v),document.addEventListener("keydown",_),f.insertAdjacentElement("afterbegin",w)},g=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),h=g.querySelector(".error__button"),S=()=>{g.removeEventListener("click",L),document.removeEventListener("keydown",q),h.removeEventListener("click",k),document.querySelector(".error").remove()},L=()=>{S()},q=e=>{"Escape"===e.key&&S()},k=()=>{S()},x=()=>{g.addEventListener("click",L),document.addEventListener("keydown",q),h.addEventListener("click",k),f.insertAdjacentElement("afterbegin",g)};n.addEventListener("submit",(o=>{o.preventDefault();const a=new FormData(n);window.load("POST","https://21.javascript.pages.academy/keksobooking/",E,x,a),window.main.activatePage(!1);const i=window.map.element.querySelector(".map__card");i&&i.remove(),n.reset(),window.map.mainPin.style.left=e,window.map.mainPin.style.top=t,window.map.updateAddressField(e,t),window.map.mainPin.addEventListener("mousedown",window.main.onMainPinClick),window.map.mainPin.addEventListener("keydown",window.main.onMainPinEnter)})),window.form={setAddressField:(e,t)=>{o.value=e+", "+t},isActive:e=>{if(e)window.utils.toggleFormElementsState(a,!1),n.classList.remove("ad-form--disabled");else{window.utils.toggleFormElementsState(a,!0),n.classList.add("ad-form--disabled");const e=window.map.pins.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)window.map.pins.querySelector(".map__pin:not(.map__pin--main)").remove()}}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=document.querySelector(".map__filters").children,o=t.querySelector(".map__pin--main"),a=document.createDocumentFragment();let i=o.style.left,r=o.style.top;const s=(t,n)=>{const a=o.offsetHeight/2,s=o.offsetWidth/2;i=window.utils.transformToInteger(t)+s,r=window.utils.transformToInteger(n)+a,e.classList.contains("map--faded")||(r+=a+22),window.form.setAddressField(i,r)};s(i,r);const d=e=>{window.data.ads=e;const n=window.data.createFeatures(e);for(let t=0;t<e.length;t++)a.appendChild(window.createPin(n[t]));t.appendChild(a)},c=function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.utils.toggleFormElementsState(n,!0),window.map={updateAddressField:s,element:e,isActive:t=>{t?(window.utils.toggleFormElementsState(n,!1),e.classList.remove("map--faded"),s(o.style.left,o.style.top),window.load("GET","https://21.javascript.pages.academy/keksobooking/data",d,c)):(window.utils.toggleFormElementsState(n,!0),e.classList.add("map--faded"),s(o.style.left,o.style.top))},mainPin:o,pins:t}})(),(()=>{const e=window.map.element.querySelector(".map__filters-container"),t=()=>{const e=window.map.element.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")},n=e=>{t(),e.classList.add("map__pin--active")},o=()=>{window.map.element.querySelector(".map__card").remove()},a=t=>{window.map.element.querySelector(".map__card")&&o();const n=(e=>{const t=document.querySelector("#card").content.querySelector(".popup"),n=t.cloneNode(!0),o=n.querySelector(".popup__avatar"),a=n.querySelector(".popup__description"),i=n.querySelector(".popup__features"),r=n.querySelector(".popup__photos");return n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=`${e.offer.price}₽/ночь`,n.querySelector(".popup__type").textContent=window.data.houseTypes[e.offer.type].name,n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout,a.textContent=e.offer.description,""===e.offer.description&&a.remove(),o.src=e.author.avatar,""===e.author.avatar&&o.remove(),e.offer.features.length?(i.innerHTML="",e.offer.features.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature",`popup__feature--${e}`),i.appendChild(t)}))):i.remove(),e.offer.photos.length?(r.innerHTML="",e.offer.photos.forEach((e=>{const n=t.querySelector(".popup__photo").cloneNode(!0);n.src=e,r.appendChild(n)}))):r.remove(),n})(window.data.ads[t]);window.map.element.insertBefore(n,e)};window.map.element.addEventListener("click",(e=>{e.target.matches(".popup__close")&&(o(),t())})),document.addEventListener("keydown",(e=>{const n=window.map.element.querySelector(".map__card");"Escape"===e.key&&window.map.element.contains(n)&&(e.preventDefault(),o(),t())})),window.map.pins.addEventListener("click",(e=>{const t=e.target.closest(".map__pin:not(.map__pin--main)");if(t){n(t);const e=t.dataset.id;a(e)}})),window.map.pins.addEventListener("keydown",(e=>{const t=e.target.closest(".map__pin:not(.map__pin--main)");if(t&&("Enter"===e.key||"Space"===e.key)){n(t);const e=t.dataset.id;a(e)}}))})(),(()=>{const e=window.map.mainPin,t={minX:0-e.offsetWidth/2,maxX:window.map.element.offsetWidth-e.offsetWidth/2,minY:130,maxY:630};e.addEventListener("mousedown",(n=>{n.preventDefault();let o={x:n.clientX,y:n.clientY};const a=n=>{n.preventDefault();let a=o.x-n.clientX,i=o.y-n.clientY;o={x:n.clientX,y:n.clientY};let r=e.offsetLeft-a,s=e.offsetTop-i;s>t.maxY?s=t.maxY:s<t.minY?s=t.minY:r>t.maxX?r=t.maxX:r<t.minX&&(r=t.minX),e.style.left=r+"px",e.style.top=s+"px",window.map.updateAddressField(e.style.left,e.style.top)},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",i)}))})(),(()=>{const e=e=>{window.form.isActive(e),window.map.isActive(e)},t=o=>{0===o.button&&e(!0),window.map.mainPin.removeEventListener("mousedown",t),window.map.mainPin.removeEventListener("keydown",n)},n=o=>{"Enter"===o.key&&e(!0),window.map.mainPin.removeEventListener("mousedown",t),window.map.mainPin.removeEventListener("keydown",n)};window.map.mainPin.addEventListener("mousedown",t),window.map.mainPin.addEventListener("keydown",n),window.main={activatePage:e,onMainPinClick:t,onMainPinEnter:n}})()})();